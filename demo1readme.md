# 海底地质岩心图文分析系统 (Geological Core Image Analysis System)

## 简介 (Introduction)

本程序是一个基于 PyQt5 的桌面应用程序，旨在对海底地质岩心图像进行分析。它提供了对岩心中孔洞、颗粒（粒度）和裂缝的自动识别、测量和统计功能。

This is a desktop application built with PyQt5 for analyzing images of submarine geological cores. It provides functionalities for automatic identification, measurement, and statistical analysis of pores, grains (granularity), and fractures within the core samples.

## 主要功能 (Features)

*   **多功能分析 (Multi-functional Analysis)**: 支持三种核心分析模式：
    *   **孔洞分析 (Porosity Analysis)**: 识别并测量孔洞的数量、面积、周长和圆度，并计算整体孔隙度。
    *   **粒度分析 (Grain Size Analysis)**: 使用分水岭算法分割颗粒，计算其等效直径、球度，并提供粒径分布统计。
    *   **裂缝分析 (Fracture Analysis)**: 检测裂缝，测量其长度、宽度和方向。
*   **交互式图像处理 (Interactive Image Processing)**:
    *   加载多种格式的岩心图像 (JPG, PNG, TIFF, BMP)。
    *   实时调整分析参数（如阈值、最小尺寸等），并即时预览结果。
    *   在原始图像和分析结果图像之间轻松切换。
*   **数据可视化与导出 (Data Visualization and Export)**:
    *   在图像上直观地标记和编号识别出的特征（孔洞、颗粒、裂缝）。
    *   将详细的分析数据展示在表格中。
    *   将所有分析结果一键导出为 Excel (`.xlsx`) 或 CSV 文件，方便后续处理。
*   **用户友好界面 (User-Friendly Interface)**:
    *   清晰的布局，将图像显示、参数控制和结果展示分开。
    *   使用选项卡（Tabs）管理不同类型的分析结果。

## 算法处理流程 (Algorithm Processing Flow)

为了实现准确的分析，本程序针对不同分析目标采用了定制化的图像处理流程：

### 1. 孔洞分析 (Porosity Analysis)
该流程旨在精确识别并测量图像中的孔洞区域。
1.  **灰度转换与降噪**: 首先将彩色岩心图像转换为灰度图，并应用**高斯模糊 (Gaussian Blur)** 以减少随机噪声对后续处理的干扰。
2.  **二值化**: 采用**自适应阈值 (Adaptive Gaussian Thresholding)** 方法将图像转换为黑白二值图像。与全局阈值相比，自适应阈值能更好地处理光照不均的情况，将孔洞（通常较暗）与背景分离。
3.  **形态学处理**: 对二值图像执行**形态学开运算 (Morphological Opening)**，此操作可以有效去除因阈值分割产生的孤立小噪点，同时基本保持原始孔洞的形状和大小。
4.  **轮廓发现与测量**: 使用 `cv2.findContours` 算法找出所有独立的孔洞轮廓。
5.  **参数计算与筛选**: 对每一个轮廓，计算其**面积**和**周长**，并由此推导出**圆度**（`4 * PI * 面积 / 周长^2`）。通过用户设定的"最小面积"和"圆度"阈值进行筛选，排除不符合条件的细小或狭长区域，最终得到精确的孔洞数据。

### 2. 粒度分析 (Grain Size Analysis)
此流程的核心是**分水岭算法 (Watershed Algorithm)**，用于分割相互接触或重叠的颗粒。
1.  **预处理**: 与孔洞分析类似，首先进行灰度转换和高斯模糊。
2.  **Otsu阈值分割**: 使用**Otsu's二值化**方法自动找到一个全局最优阈值来区分颗粒和背景。
3.  **确定前景与背景**:
    *   通过**距离变换 (Distance Transform)** 和阈值化，可以确定哪些区域是"确定无疑的颗粒"（前景）。
    *   通过对二值图像进行**膨胀 (Dilation)** 操作，可以确定"确定无疑的背景"。
4.  **标记物生成**: "前景"区域被标记为不同的序号，作为分水岭算法的"种子点"。
5.  **执行分水岭**: 以生成的标记物为基础，运行**分水岭算法**。该算法会将图像中的"山脊"识别为颗粒间的边界，从而有效分割粘连的颗粒。
6.  **颗粒测量**: 算法执行完毕后，每个被分割出的独立区域被视为一个颗粒。程序会计算每个颗粒的**等效直径**和**球度**，并进行统计。

### 3. 裂缝分析 (Fracture Analysis)
该流程专注于检测图像中的线性结构——裂缝。
1.  **边缘检测**: 在灰度和降噪处理后，使用经典的 **Canny 边缘检测算法** 来提取图像中所有的边缘。Canny 算法因其高精度和对噪声的鲁棒性而被选用。
2.  **形态学增强**: 对 Canny 算法输出的边缘图像进行一次**膨胀 (Dilation)** 操作，以连接裂缝中可能存在的微小断点，使裂缝线条更加连续。
3.  **直线检测**: 应用**概率霍夫变换 (Probabilistic Hough Transform)** (`cv2.HoughLinesP`) 在增强后的边缘图上检测直线段。该方法效率高，能直接返回直线的起点和终点。
4.  **参数计算与筛选**: 对检测出的每一条线段，根据用户设置的"最小裂缝长度"进行筛选。对于符合条件的线段，计算其**长度**、**方向（角度）**，并通过一个简化的方法估算其**宽度**，最终完成裂缝的识别和测量。

## 技术栈 (Technology Stack)

*   **GUI**: PyQt5
*   **图像处理 (Image Processing)**: OpenCV-Python, Scikit-image
*   **数据处理 (Data Handling)**: NumPy, Pandas

## 环境要求 (Requirements)

要运行此程序，您需要安装以下 Python 库：

```bash
pip install PyQt5 opencv-python scikit-image numpy pandas
```

## 如何运行 (How to Run)

1.  确保您已安装上述所有必需的库。
2.  在终端中执行以下命令：

```bash
python demo1.py
```

## 使用说明 (Usage Guide)

1.  **加载图像**: 点击 "**加载岩心图像**" 按钮，选择一张岩心图片。
2.  **选择分析类型**: 在左侧的 "**分析参数设置**" 区域，通过下拉菜单选择您想进行的分析类型（"孔洞分析"、"粒度分析" 或 "裂缝分析"）。
3.  **调整参数**: 根据图像特点和分析需求，拖动滑块调整相应的检测参数。
4.  **执行分析**: 点击 "**执行分析**" 按钮。程序将处理图像，并在界面上显示分析结果。
    *   右侧图像窗口将显示带有标记的分析图像。
    *   右侧的结果选项卡将填充详细数据。
5.  **查看结果**:
    *   点击 "**原始图像**" 和 "**分析结果**" 按钮来回切换视图。
    *   在右侧的选项卡中查看不同分析的详细表格和统计摘要。
6.  **导出结果**: 点击 "**导出分析结果**" 按钮，选择保存位置和文件类型（Excel 或 CSV），即可保存数据。
