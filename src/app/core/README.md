# 核心模块: 业务与数据层

该目录是应用程序的大脑，包含业务逻辑层和数据处理层的所有组件。

## 文件结构

-   **`controller.py`**: **业务逻辑层**。作为应用程序的中心协调器，通过信号与槽机制连接UI层和数据处理层。
-   **`image_processor.py`**: **数据处理层**。封装了所有核心的图像处理算法，包括阈值分割、形态学操作、裂缝检测与测量等。
-   **`unit_converter.py`**: **工具**。提供像素单位与物理单位（毫米）之间的转换功能。
-   **`analysis_stages.py`**: **数据模型**。定义了分析流程中各个阶段的枚举类型，用于状态管理和结果索引。

## Controller 设计

`Controller`类是UI层和数据层之间的桥梁，其核心职责包括：

-   **状态管理**:
    -   持有当前加载的图像 (`current_image`)、DPI信息 (`current_dpi`) 和文件路径。
    -   管理一个完整的分析参数字典 (`analysis_params`)，该字典可以被导入/导出为JSON。
    -   维护一个结果字典 (`analysis_results`)，以`AnalysisStage`为键，存储每个处理阶段的输出。
-   **参数协调**:
    -   提供`update_parameter`方法，允许UI层的对话框修改特定参数（如`threshold.method`）。
    -   当参数更新时，自动触发依赖于该参数的**链式预览更新**。例如，更改阈值会依次触发阈值和形态学两个阶段的重新计算和预览。
-   **流程驱动**:
    -   `load_image_from_file`: 响应加载图像的请求，进行预处理并触发初始预览。
    -   `run_fracture_analysis`: 响应"开始分析"的请求，执行一个完整的、自包含的分析流水线，并分发最终结果。
-   **结果分发**:
    -   通过`preview_stage_updated`信号，将每个处理阶段的中间结果（图像和参数）发送到UI层进行实时预览。
    -   通过`analysis_complete`信号，在分析全部完成后，将最终的量化测量数据发送到UI层进行展示。

## 图像处理流水线

`run_fracture_analysis`方法中执行的完整图像处理流水线如下：

1.  **单位换算**: 基于DPI信息，将用户在UI设置的物理过滤参数（如`min_length_mm`）转换为像素单位。
2.  **阈值分割**: 使用用户选择的算法和参数（如Sauvola, Niblack等）将灰度图转换为二值图。
3.  **形态学处理**: 对二值图像应用开/闭运算，以消除噪声、填充裂缝内部空洞。
4.  **裂缝分析与过滤**:
    -   在处理后的二值图上检测所有连通域（轮廓）。
    -   对每个轮廓计算其**长宽比**和**精确长度**（通过骨架化）。
    -   根据用户设定的最小长宽比和最小长度（像素）对轮廓进行过滤，剔除不符合条件的噪声。
5.  **（可选）裂缝合并**: (待实现) 如果启用，则对断开但邻近的裂缝进行合并。
6.  **结果可视化**: 将所有通过过滤的有效裂缝轮廓，以高亮颜色绘制在原始图像上。
7.  **定量测量**:
    -   计算所有有效裂缝的总数量、总面积（mm²）和总长度（mm）。
    -   为每条裂缝生成详细的物理属性列表。
8.  **结果分发**: 将可视化图像和定量数据打包，通过信号发送给UI层。

## 分析阶段

系统定义了以下处理阶段（在`analysis_stages.py`中）：
- `ORIGINAL`: 原始图像
- `GRAYSCALE`: 灰度图像
- `THRESHOLD`: 阈值分割
- `MORPHOLOGY`: 形态学处理
- `DETECTION`: 最终检测和可视化的裂缝结果
- `MEASUREMENT`: 量化的物理测量数据

每个阶段的处理结果都保存在控制器的`analysis_results`字典中，以便在UI层展示和后续处理。 