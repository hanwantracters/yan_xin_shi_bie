# 海底地质岩心图像分析算法说明

本文档详细介绍了“海底地质岩心孔洞、粒度、裂缝图文分析系统”中所使用的核心图像处理与识别算法。

## 1. 孔洞分析 (Porosity Analysis)

孔洞分析的目标是识别图像中的孔隙区域，并计算其数量、大小、形状等参数，最终得出总体的孔隙度。

### 算法流程：

1.  **灰度化与降噪**:
    *   首先将加载的彩色岩心图像转换为灰度图像。
    *   使用高斯滤波器 (`cv2.GaussianBlur`) 对图像进行平滑处理，以减少随机噪声对后续阈值分割的影响。

2.  **二值化分割**:
    *   采用**自适应阈值分割** (`cv2.adaptiveThreshold` with `ADAPTIVE_THRESH_GAUSSIAN_C`) 将灰度图像转换为黑白二值图像。与全局阈值（如Otsu法）不同，自适应阈值能更好地处理光照不均的图像，它会根据像素邻域的亮度分布来确定该像素的阈值。
    *   算法将低于局部均值的像素点识别为孔洞（黑色背景，白色前景）。

3.  **形态学处理**:
    *   对二值图像执行**形态学开运算** (`cv2.morphologyEx` with `MORPH_OPEN`)。开运算（先腐蚀后膨胀）可以有效去除二值化过程中产生的孤立小噪点，同时保持主要孔洞区域的形状基本不变。

4.  **轮廓发现与筛选**:
    *   使用 `cv2.findContours` 函数检测所有独立的白色区域（即潜在的孔洞）的轮廓。
    *   对每个检测到的轮廓进行筛选：
        *   **面积筛选**: 剔除面积小于预设`最小孔洞面积`的轮廓。
        *   **形状筛选**: 计算轮廓的**圆度** (Circularity)，其计算公式为 `(4 * π * Area) / (Perimeter^2)`。圆度值越接近1，表示形状越接近圆形。通过设置圆度阈值（代码中为0.5），可以过滤掉一些因纹理或噪声产生的狭长、不规则区域，保留更可能是孔洞的区域。

5.  **参数计算与可视化**:
    *   对通过筛选的孔洞，计算其**面积** (`cv2.contourArea`) 和**周长** (`cv2.arcLength`)。
    *   在原始图像的副本上使用不同颜色绘制孔洞的轮廓和编号，以便用户直观地查看分析结果。
    *   统计所有孔洞的总数、平均面积，并计算**孔隙度**（总孔洞面积 / 图像总面积）。

## 2. 粒度分析 (Grain Size Analysis)

粒度分析旨在分割出图像中的单个岩石颗粒，并测量它们的尺寸分布和形状特征。由于颗粒之间常常紧密接触，算法的核心是使用分水岭算法进行有效分离。

### 算法流程：

1.  **灰度化与二值化**:
    *   与孔洞分析类似，首先将图像灰度化。
    *   使用 **Otsu's 二值化** (`cv2.threshold` with `THRESH_OTSU`)。Otsu方法能自动找到一个最佳的全局阈值，将图像分为前景（颗粒）和背景。

2.  **噪声去除与前景/背景确定**:
    *   通过**形态学开运算**去除噪声。
    *   通过**形态学膨胀** (`cv2.dilate`) 操作，可以明确地确定图像中的背景区域 (`sure_bg`)。
    *   使用**距离变换** (`cv2.distanceTransform`) 计算二值图像中每个前景像素到最近背景像素的距离。距离变换结果图中，亮度越高的区域越可能是颗粒的中心。
    *   对距离变换的结果进行阈值处理，得到确定的前景区域 (`sure_fg`)，即颗粒的"种子点"。

3.  **分水岭算法分割**:
    *   通过从确定的背景 (`sure_bg`) 中减去确定的前景 (`sure_fg`)，得到一个"未知区域"，这个区域即为颗粒之间需要被分割的边界。
    *   利用 `cv2.connectedComponents` 对确定的前景区域进行标记，为每个独立的颗粒种子分配一个唯一的ID。
    *   最后，调用**分水岭算法** (`cv2.watershed`)。该算法会从每个标记好的"种子点"开始，向外"灌水"，直到不同区域的水相遇。相遇的地方就是颗粒的边界，算法会在此处建立"堤坝"。
    *   最终，该算法能有效地在原始图像上分割出相互接触的颗粒。

4.  **参数计算与可视化**:
    *   遍历分割后的每个标记区域（即每个颗粒）。
    *   计算每个颗粒的**等效直径**（基于面积 `Area = π * (D/2)^2` 反算出的直径 `D`）和**球度** (Sphericity，与圆度计算方式相同)。
    *   根据等效直径对颗粒进行大、中、小三类的尺寸分布统计。
    *   在图像上绘制颗粒的边界和编号，并更新统计数据，如颗粒总数和平均直径。

